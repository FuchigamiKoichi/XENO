<!-- public/index.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="stylesheet" href="./index.css">
  <meta charset="UTF-8">
  <title>XENO</title>
  <style>
    #rooms {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
  </style>
</head>
<body>
  <h1>XENO</h1>

  <div class="select_rooms", id="selectRooms">
    <!-- プレイヤー名 -->
    <input type="text" id="name" placeholder="プレイヤー名">

    <hr>
    <!-- ルーム選択 -->

      <div id="rooms"></div>
      <div class="room_buttons">
        <div>
          <input type="text" id="roomIdInput" placeholder="ルームID">
        </div>
        <div>
          <button id="createRoomBtn">ルームの作成</button>
          <button id="showRoomsBtn">ルームの確認</button>
        </div>
      </div>
    </div>
  </div>

  <div id="roomInfo"></div>
  <div id="gameArea"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // プレイヤー名の登録
    const select_room = document.getElementById('selectRooms');
    const text_name = document.getElementById('name');
    

    // ルームの選択
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const showRoomsBtn = document.getElementById('showRoomsBtn');
    const roomIdInput = document.getElementById('roomIdInput');
    const roomInfo = document.getElementById('roomInfo');
    const gameArea = document.getElementById('gameArea');

    const rooms = document.getElementById('rooms');
    const gameStart = document.getElementById('startGameBtn');

    function joinRoom(roomId){
      socket.emit('joinRoom', roomId, (response) => {
        if (!response || !response.success) {
          alert(response ? response.message : 'ルーム参加に失敗しました');
        } else {
          window.location.replace(`game.html?roomid=${roomId}?playerid=${response.playerId}?players=${response.players}`)
        }
      });
    }

    // ルームを確認する
    showRoomsBtn.addEventListener('click', () => {
      const player_name = text_name.value;
      socket.emit('registPlayer', {name: player_name});
      socket.emit('showRooms', { maxPlayers: 4 }, (response) => {
        if (response && response.rooms) {
          let room_list = Object.keys(response.rooms);
          rooms.innerHTML = "";
          for (let i=0; i<room_list.length; i++) {
            let item = document.createElement('button');
            let back = document.createElement('div');
            back.style.height = "140px";
            back.style.width = "230px";
            back.style.backgroundColor = "#da7326";
            back.style.borderWidth = "6px";
            back.style.borderStyle = "solid";
            back.style.borderRadius = "10px";
            back.style.margin = "auto";
            back.style.padding = "auto";
            item.style.height = "180px";
            item.style.width = "270px";
            item.style.borderWidth = "6px";
            item.style.borderRadius = "10px";
            item.style.backgroundColor = "#3e1e00"
            item.style.borderStyle = "solid";
            let contentRoomId = document.createElement('p');
            contentRoomId.textContent = `${room_list[i]}`;
            contentRoomId.style.margin = '3px';
            back.appendChild(contentRoomId);
            let contentOwner = document.createElement('p');
            contentOwner.textContent = 'オーナー';
            contentOwner.style.margin = '3px';
            back.appendChild(contentOwner);
            let contentOwnerName = document.createElement('p');
            contentOwnerName.textContent = response.players[response.rooms[room_list[i]].owner].name;
            contentOwnerName.style.margin = '3px';
            back.appendChild(contentOwnerName);
            // item.textContent = room_list[i];
            item.addEventListener('click', () => {
              joinRoom(item.value)
            });
            item.appendChild(back);
            rooms.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
          }
        }
      })
    })

    // ルームを作成する
    createRoomBtn.addEventListener('click', () => {
      
      const player_name = text_name.value;
      socket.emit('registPlayer', {name: player_name});
      select_room.style.display = 'block';

      socket.emit('createRoom', { maxPlayers: 4 }, (response) => {
        if (response && response.roomId) {
          joinRoom(response.roomId)
          // roomInfo.innerText = 'ルームが作成されました: ' + response.roomId;
        }
      });
    });

    // 既存のルームに参加する
    joinRoomBtn.addEventListener('click', () => {
      const roomId = roomIdInput.value;
      
      socket.emit('joinRoom', roomId, (response) => {
        if (!response || !response.success) {
          alert(response ? response.message : 'ルーム参加に失敗しました');
        } else {
          window.replace()
        }
      });
    });

    // ルームのメンバー更新を受け取る
    socket.on('updateRoomMembers', (data) => {
      roomInfo.innerText = `メンバーが更新されました: ${data.players.join(', ')}`;
    });

    // ゲーム開始
    // ここではサンプルとして、参加後すぐに開始ボタンを出す例
    function startGame(roomId) {
      socket.emit('startGame', roomId);
      socket.on('redirect', (url) => {
        console.log('画面遷移:',url);
        location.replace(url);
      })
    }

    // ゲーム開始イベントを受け取る
    socket.on('gameStarted', (data) => {
      gameArea.innerText = data.message;
      // ここでゲーム用の画面を作っていく
    });

    // ゲーム状態更新イベントを受け取る
    socket.on('gameStateUpdate', (data) => {
      // data.action などを使ってゲーム画面をリアルタイム更新
      // console.log('gameStateUpdate', data);
    });

    // プレイヤー操作を送る例
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp') {
        // 例えば現在のルームIDを roomId として
        const roomId = roomIdInput.value;
        socket.emit('playerAction', roomId, { move: 'up' });
      }
    });
  </script>
</body>
</html>
