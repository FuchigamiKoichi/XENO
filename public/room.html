<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待機部屋</title>
</head>
<body>
    <h1 id="title"></h1>
    <div class="container">
        <div id="players"></div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        let title = document.getElementById("title")
        let urls = String(window.location.href).split('?')
        let players = urls[3].substr(8,urls[3].length).split(',')
        const playerId = urls[2].substr(9,urls[1].length)
        const roomId = urls[1].substr(7,urls[1].length)

        // console.log(`playerId: ${playerId}`)

        // console.log(`players: ${players}`)

        title.textContent = roomId

        socket.emit('changeSocketid', {id:playerId, roomId: roomId})

        // ルームのメンバー更新を受け取る
        socket.on('updateRoomMembers', (data) => {
            players = data.players
            window.location.replace(`room.html?roomid=${roomId}?playerid=${playerId}?players=${players}`)
        });

        function createPlayerBlock(player) {
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="player-block">
                <p>${player}</p>
                </div>
            `;
            return div;
        }

        socket.emit('getPlayerNames', players, (response) => {
            if(!response || !response.success){
                alert(response ? response.message : 'プレイヤー情報の取得に失敗しました');
            }else{
                let playerNames = response.playerNames
                const showPlayers = document.getElementById("players");
                for(let i=0; i<playerNames.length; i++){
                    showPlayers.appendChild(createPlayerBlock(playerNames[i]))
                }
            }
        })
    </script>
</body>
</html>